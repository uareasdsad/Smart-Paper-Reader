<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Paper Reader v4.0</title>
    <link href="https://cdn.staticfile.org/twitter-bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .markdown-body { padding: 20px; background-color: #f8f9fa; border-radius: 5px; border: 1px solid #ddd; }
        .loading-spinner { display: none; }
        #dashboard-section { display: none; }
        /* è®©æ¨¡æ€æ¡†å†…å®¹ç¨å¾®å¥½çœ‹ç‚¹ */
        .modal-body img { max-width: 100%; }
        pre { background: #2d2d2d; color: #ccc; padding: 10px; border-radius: 4px; }
    </style>
</head>
<body class="bg-light">

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-9">
            
            <div class="text-center mb-4">
                <h1 class="text-primary">ğŸ§  Smart Paper Reader</h1>
                <p class="text-muted">åŸºäº DeepSeek v4.0 çš„æ™ºèƒ½è®ºæ–‡åˆ†æå¹³å° (Redis+MQæé€Ÿç‰ˆ)</p>
            </div>

            <div id="login-section" class="card shadow-sm">
                <div class="card-body p-4">
                    <h4 class="card-title mb-3 text-center">ç³»ç»Ÿç™»å½•</h4>
                    <div class="mb-3">
                        <label class="form-label">ç”¨æˆ·å</label>
                        <input type="text" id="username" class="form-control" placeholder="é»˜è®¤: zhouxin" value="zhouxin">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">å¯†ç </label>
                        <input type="password" id="password" class="form-control" placeholder="é»˜è®¤: 123456" value="123456">
                    </div>
                    <button class="btn btn-primary w-100" onclick="doLogin()">ç™» å½•</button>
                    <div id="login-msg" class="text-danger mt-2 text-center"></div>
                </div>
            </div>

            <div id="dashboard-section">
                <div class="alert alert-info d-flex justify-content-between align-items-center shadow-sm">
                    <div>
                        <span class="fs-5 me-3">ğŸ‘¤ ç”¨æˆ·: <strong id="show-username">--</strong></span>
                        <span class="fs-5">ğŸ’° å‰©ä½™ç§¯åˆ†: <strong id="show-points" class="text-danger">--</strong></span>
                    </div>
                    <button class="btn btn-sm btn-outline-secondary" onclick="logout()">é€€å‡ºç™»å½•</button>
                </div>

                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white fw-bold">ğŸ“„ ä¸Šä¼ è®ºæ–‡ PDF</div>
                    <div class="card-body">
                        <div class="input-group mb-3">
                            <input type="file" class="form-control" id="fileInput" accept=".pdf">
                            <button class="btn btn-success px-4" type="button" onclick="uploadFile()">å¼€å§‹åˆ†æ</button>
                        </div>
                        <small class="text-muted">
                            <i class="bi bi-info-circle"></i> è§„åˆ™ï¼šVIP ç”¨æˆ·å…è´¹ï¼Œæ™®é€šç”¨æˆ·æ¯æ¬¡æ‰£é™¤ 1 ç§¯åˆ† (åŸºäº Redis åŸå­æ‰£è´¹ï¼Œé˜²æ­¢å¹¶å‘è¶…å–)
                        </small>
                    </div>
                </div>

                <div class="card shadow-sm">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <span class="fw-bold">ğŸ“‹ å†å²ä»»åŠ¡ (æœ¬åœ°è®°å½•)</span>
                        <button class="btn btn-sm btn-primary" onclick="refreshList()">åˆ·æ–°åˆ—è¡¨</button>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>ä»»åŠ¡ID</th>
                                    <th>æ–‡ä»¶å</th>
                                    <th>çŠ¶æ€</th>
                                    <th class="text-end">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="task-list-body">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="reportModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title">ğŸ“„ æ·±åº¦åˆ†ææŠ¥å‘Š</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="markdown-content" class="markdown-body">
                    </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.staticfile.org/axios/1.3.6/axios.min.js"></script>
<script src="https://cdn.staticfile.org/twitter-bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.staticfile.org/marked/4.3.0/marked.min.js"></script>

<script>
    // é…ç½®åç«¯åœ°å€
    const API_BASE = 'http://localhost:8080';
    
    const TOKEN_KEY = 'paper_token';
    const TASKS_KEY = 'paper_tasks'; 

    // åˆå§‹åŒ–
    window.onload = function() {
        const token = localStorage.getItem(TOKEN_KEY);
        if (token) {
            showDashboard();
        }
    };

    // --- 1. ç™»å½• ---
    function doLogin() {
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        const msgDiv = document.getElementById('login-msg');
        msgDiv.innerText = "";
        
        // å¢åŠ ä¸€ç‚¹äº¤äº’åé¦ˆ
        const btn = document.querySelector('button[onclick="doLogin()"]');
        const originalText = btn.innerText;
        btn.innerText = "ç™»å½•ä¸­...";
        btn.disabled = true;
        
        axios.post(`${API_BASE}/login`, { username: u, password: p })
            .then(res => {
                const data = res.data;
                if (data.code === 200) {
                    localStorage.setItem(TOKEN_KEY, data.token);
                    localStorage.setItem('username', data.username);
                    localStorage.setItem('points', data.points);
                    showDashboard();
                } else {
                    msgDiv.innerText = data.msg;
                }
            })
            .catch(err => {
                console.error(err);
                if (err.code === "ERR_NETWORK") {
                    msgDiv.innerText = "æ— æ³•è¿æ¥åç«¯ï¼Œè¯·æ£€æŸ¥åç«¯æ˜¯å¦å¯åŠ¨ (F12çœ‹æ§åˆ¶å°)";
                } else if (typeof axios === 'undefined') {
                    msgDiv.innerText = "Axios åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ";
                } else {
                    msgDiv.innerText = "ç™»å½•å¼‚å¸¸: " + err.message;
                }
            })
            .finally(() => {
                btn.innerText = originalText;
                btn.disabled = false;
            });
    }

    function logout() {
        localStorage.removeItem(TOKEN_KEY);
        location.reload();
    }

    function showDashboard() {
        document.getElementById('login-section').style.display = 'none';
        document.getElementById('dashboard-section').style.display = 'block';
        document.getElementById('show-username').innerText = localStorage.getItem('username');
        document.getElementById('show-points').innerText = localStorage.getItem('points');
        renderTaskList();
    }

    // --- 2. ä¸Šä¼  (å·²ä¿®å¤ Network Error é—®é¢˜) ---
    function uploadFile() {
        const fileInput = document.getElementById('fileInput');
        if (fileInput.files.length === 0) {
            alert("è¯·é€‰æ‹©æ–‡ä»¶");
            return;
        }

        const formData = new FormData();
        formData.append("file", fileInput.files[0]);

        const token = localStorage.getItem(TOKEN_KEY);
        const btn = document.querySelector('.btn-success');
        const originalText = btn.innerText;
        btn.innerText = "æ­£åœ¨ä¸Šä¼ ...";
        btn.disabled = true;

        axios.post(`${API_BASE}/upload`, formData, {
            headers: { 
                'Authorization': 'Bearer ' + token
            }
        }).then(res => {
            const msg = res.data; 
            alert(msg); 

            const match = msg.match(/ä»»åŠ¡ID:\s*(\d+)/);
            if (match) {
                const taskId = match[1];
                addTaskToLocal(taskId, fileInput.files[0].name);
                let pts = parseInt(document.getElementById('show-points').innerText);
                if (!isNaN(pts)) {
                    document.getElementById('show-points').innerText = pts - 1;
                }
            }
        }).catch(err => {
            console.error("ä¸Šä¼ é”™è¯¯è¯¦æƒ…:", err);
            let errMsg = "ä¸Šä¼ å¤±è´¥";
            if (err.response) {
                errMsg += `: ${err.response.data || err.response.statusText}`;
            } else if (err.code === "ERR_NETWORK") {
                errMsg += ": ç½‘ç»œé”™è¯¯ã€‚è¯·æ£€æŸ¥åç«¯æ˜¯å¦é…ç½®äº† max-file-size=50MB ä»¥åŠ CorsConfigã€‚";
            } else {
                errMsg += `: ${err.message}`;
            }
            alert(errMsg);
        }).finally(() => {
            btn.innerText = originalText;
            btn.disabled = false;
            fileInput.value = ''; 
        });
    }

    // --- 3. ä»»åŠ¡åˆ—è¡¨ç®¡ç† ---
    function addTaskToLocal(id, name) {
        let tasks = JSON.parse(localStorage.getItem(TASKS_KEY) || "[]");
        tasks.unshift({ id: id, name: name });
        localStorage.setItem(TASKS_KEY, JSON.stringify(tasks));
        renderTaskList();
    }

    function renderTaskList() {
        const tasks = JSON.parse(localStorage.getItem(TASKS_KEY) || "[]");
        const tbody = document.getElementById('task-list-body');
        tbody.innerHTML = '';

        tasks.forEach(task => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><span class="badge bg-secondary">${task.id}</span></td>
                <td>${task.name}</td>
                <td><span class="badge bg-secondary" id="status-${task.id}">æœªæŸ¥è¯¢</span></td>
                <td class="text-end">
                    <button class="btn btn-sm btn-outline-primary" onclick="checkTask('${task.id}')">
                        æŸ¥çœ‹ç»“æœ
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function refreshList() {
        renderTaskList();
    }

    // --- 4. æŸ¥è¯¢ç»“æœ (èµ° Redis ç¼“å­˜) ---
    function checkTask(taskId) {
        const token = localStorage.getItem(TOKEN_KEY);
        const statusSpan = document.getElementById(`status-${taskId}`);
        
        statusSpan.className = "badge bg-warning text-dark";
        statusSpan.innerText = "æŸ¥è¯¢ä¸­...";

        axios.get(`${API_BASE}/task/${taskId}`, {
            headers: { 'Authorization': 'Bearer ' + token }
        }).then(res => {
            const content = res.data;
            
            if (content.length < 100 && (content.includes("å¤„ç†ä¸­") || content.includes("ä»»åŠ¡"))) {
                statusSpan.className = "badge bg-info";
                statusSpan.innerText = "å¤„ç†ä¸­";
                alert(`ä»»åŠ¡ ${taskId}: ${content}`);
            } else {
                statusSpan.className = "badge bg-success";
                statusSpan.innerText = "å·²å®Œæˆ";
                
                document.getElementById('markdown-content').innerHTML = marked.parse(content);
                const modal = new bootstrap.Modal(document.getElementById('reportModal'));
                modal.show();
            }
        }).catch(err => {
            statusSpan.className = "badge bg-danger";
            statusSpan.innerText = "å‡ºé”™";
            console.error(err);
            alert("æŸ¥è¯¢å‡ºé”™: " + (err.response ? err.response.data : err.message));
        });
    }
</script>

</body>
</html>